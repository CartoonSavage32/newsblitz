{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///E:/NewsBlitz/Client/app/api/feedback/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\r\nimport nodemailer from 'nodemailer';\r\n\r\n// Type definition for feedback form data\r\ninterface FeedbackData {\r\n  feedbackType: 'suggestion' | 'issue' | 'praise';\r\n  category: 'content' | 'design' | 'performance' | 'features' | 'other';\r\n  name?: string;\r\n  email: string;\r\n  message: string;\r\n  rating?: string; // Only present when feedbackType === 'praise'\r\n  device?: string; // Only present when feedbackType === 'issue'\r\n}\r\n\r\n// Create reusable transporter (created once, reused for all requests)\r\nlet transporter: nodemailer.Transporter | null = null;\r\n\r\nfunction getTransporter(): nodemailer.Transporter {\r\n  if (!transporter) {\r\n    const emailUser = process.env.FEEDBACK_EMAIL_USER;\r\n    const emailPassword = process.env.FEEDBACK_EMAIL_APP_PASSWORD;\r\n\r\n    if (!emailUser || !emailPassword) {\r\n      throw new Error('Email configuration missing: FEEDBACK_EMAIL_USER and FEEDBACK_EMAIL_APP_PASSWORD are required');\r\n    }\r\n\r\n    transporter = nodemailer.createTransport({\r\n      service: 'gmail',\r\n      auth: {\r\n        user: emailUser,\r\n        pass: emailPassword, // Gmail App Password\r\n      },\r\n    });\r\n  }\r\n  return transporter;\r\n}\r\n\r\n// Map feedback type to display name\r\nfunction getFeedbackTypeDisplay(type: FeedbackData['feedbackType']): string {\r\n  const typeMap: Record<FeedbackData['feedbackType'], string> = {\r\n    suggestion: 'Suggestion',\r\n    issue: 'Report Issue',\r\n    praise: 'Praise',\r\n  };\r\n  return typeMap[type] || type;\r\n}\r\n\r\n// Map category to display name\r\nfunction getCategoryDisplay(category: FeedbackData['category']): string {\r\n  const categoryMap: Record<FeedbackData['category'], string> = {\r\n    content: 'Content Quality',\r\n    design: 'User Interface',\r\n    performance: 'App Performance',\r\n    features: 'Features',\r\n    other: 'Other',\r\n  };\r\n  return categoryMap[category] || category;\r\n}\r\n\r\n// Build email body from feedback data\r\nfunction buildEmailBody(feedbackData: FeedbackData): string {\r\n  const timestamp = new Date().toISOString();\r\n  const feedbackTypeDisplay = getFeedbackTypeDisplay(feedbackData.feedbackType);\r\n  const categoryDisplay = getCategoryDisplay(feedbackData.category);\r\n\r\n  let body = `New feedback submission received from NewsBlitz\\n\\n`;\r\n  body += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\\n\\n`;\r\n  body += `Type: ${feedbackTypeDisplay}\\n`;\r\n  body += `Category: ${categoryDisplay}\\n\\n`;\r\n\r\n  if (feedbackData.name) {\r\n    body += `Name: ${feedbackData.name}\\n`;\r\n  }\r\n\r\n  body += `Email: ${feedbackData.email}\\n\\n`;\r\n  body += `Message:\\n${feedbackData.message}\\n\\n`;\r\n\r\n  // Include rating if present (only for praise type)\r\n  if (feedbackData.rating) {\r\n    const ratingLabels: Record<string, string> = {\r\n      '5': '5 - Excellent',\r\n      '4': '4 - Very Good',\r\n      '3': '3 - Good',\r\n      '2': '2 - Fair',\r\n      '1': '1 - Poor',\r\n    };\r\n    body += `Rating: ${ratingLabels[feedbackData.rating] || feedbackData.rating}\\n\\n`;\r\n  }\r\n\r\n  // Include device info if present (only for issue type)\r\n  if (feedbackData.device) {\r\n    body += `Device Information: ${feedbackData.device}\\n\\n`;\r\n  }\r\n\r\n  body += `━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━\\n`;\r\n  body += `Submitted at: ${timestamp}\\n`;\r\n\r\n  return body;\r\n}\r\n\r\nexport async function POST(request: Request) {\r\n  try {\r\n    const feedbackData = await request.json() as FeedbackData;\r\n\r\n    // Validate required fields\r\n    if (!feedbackData.feedbackType || !feedbackData.category || !feedbackData.message || !feedbackData.email) {\r\n      return NextResponse.json(\r\n        { error: 'Missing required fields: feedbackType, category, message, and email are required' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate feedbackType enum\r\n    const validFeedbackTypes: FeedbackData['feedbackType'][] = ['suggestion', 'issue', 'praise'];\r\n    if (!validFeedbackTypes.includes(feedbackData.feedbackType)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid feedback type' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate category enum\r\n    const validCategories: FeedbackData['category'][] = ['content', 'design', 'performance', 'features', 'other'];\r\n    if (!validCategories.includes(feedbackData.category)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid category' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate email format\r\n    const emailRegex = /^[^\\s@]+@[^\\s@]+\\.[^\\s@]+$/;\r\n    if (!emailRegex.test(feedbackData.email)) {\r\n      return NextResponse.json(\r\n        { error: 'Invalid email format' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Validate message is not empty\r\n    if (typeof feedbackData.message !== 'string' || feedbackData.message.trim().length === 0) {\r\n      return NextResponse.json(\r\n        { error: 'Message cannot be empty' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    // Send email using Nodemailer\r\n    try {\r\n      const mailTransporter = getTransporter();\r\n      const emailUser = process.env.FEEDBACK_EMAIL_USER;\r\n      const emailTo = process.env.FEEDBACK_EMAIL_TO || emailUser;\r\n\r\n      if (!emailTo) {\r\n        throw new Error('FEEDBACK_EMAIL_TO or FEEDBACK_EMAIL_USER must be set');\r\n      }\r\n\r\n      const feedbackTypeDisplay = getFeedbackTypeDisplay(feedbackData.feedbackType);\r\n      const emailSubject = `[NewsBlitz Feedback] ${feedbackTypeDisplay}`;\r\n      const emailBody = buildEmailBody(feedbackData);\r\n\r\n      await mailTransporter.sendMail({\r\n        from: emailUser,\r\n        to: emailTo,\r\n        subject: emailSubject,\r\n        text: emailBody,\r\n      });\r\n\r\n      console.log('Feedback email sent successfully');\r\n    } catch (emailError) {\r\n      // Log email error but don't expose sensitive details to frontend\r\n      console.error('Failed to send feedback email:', emailError);\r\n      return NextResponse.json(\r\n        { error: 'Failed to send feedback. Please try again later.' },\r\n        { status: 500 }\r\n      );\r\n    }\r\n\r\n    return NextResponse.json({\r\n      ok: true,\r\n      message: 'Feedback received successfully',\r\n      type: feedbackData.feedbackType,\r\n      category: feedbackData.category,\r\n    });\r\n  } catch (error) {\r\n    console.error('Feedback processing error:', error);\r\n    return NextResponse.json(\r\n      { error: 'Internal server error' },\r\n      { status: 500 }\r\n    );\r\n  }\r\n}\r\n\r\n"],"names":[],"mappings":"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"}}]
}